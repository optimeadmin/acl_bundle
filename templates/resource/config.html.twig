{% extends '@OptimeAcl/layout.html.twig' %}

{% block page_header 'Access Control Configuration' %}

{% block page_header_actions %}
    <a href="{{ path('optime_acl_resources_clean') }}" class="btn btn-outline-danger">
        Clean Unused Resources
    </a>
{% endblock %}

{% from _self import render_form %}

{% set active_tab = persisted_form.vars.submitted
    ? 'persisted'
    : (news_form.vars.submitted
    ? 'news' : (hidden_form.vars.submitted ? 'hidden' : (persisted_form.references|length > 0 ? 'persisted' : 'news'))
    ) %}

{% block content %}

    <ul class="nav nav-pills mb-3" id="references-config-tab">
        {% if persisted_form.references|length > 0 %}
            <li class="nav-item">
                <button class="nav-link {{ active_tab == 'persisted' ? 'active' }}" data-bs-toggle="pill"
                        data-bs-target="#persisted-references" type="button">
                    Persisted References
                </button>
            </li>
        {% endif %}
        <li class="nav-item">
            <button class="nav-link {{ active_tab == 'news' ? 'active' }}" data-bs-toggle="pill"
                    data-bs-target="#new-references" type="button">
                New References
            </button>
        </li>
        {% if hidden_form.references|length > 0 %}
            <li class="nav-item">
                <button class="nav-link {{ active_tab == 'hidden' ? 'active' }}" data-bs-toggle="pill"
                        data-bs-target="#hidden-references" type="button">
                    Hidden References
                </button>
            </li>
        {% endif %}
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade {{ active_tab == 'persisted' ? 'active show' }}" id="persisted-references">

            {{ render_form(persisted_form) }}

        </div>
        <div class="tab-pane fade {{ active_tab == 'news' ? 'active show' }}" id="new-references">

            {{ render_form(news_form) }}

        </div>
        <div class="tab-pane fade {{ active_tab == 'hidden' ? 'active show' }}" id="hidden-references">

            {{ render_form(hidden_form) }}

        </div>
    </div>
{% endblock %}

{% macro render_form(form, buttonTitle) %}
    {% form_theme form 'bootstrap_5_layout.html.twig' %}
    {{ form_start(form, {attr: {novalidate: true}}) }}

    <table class="table table-bordered">
        <thead>
        <tr>
            <th>Apply</th>
            <th>Resource</th>
            <th>Reference</th>
            <th>Route Name</th>
            <th>Route Path</th>
            <th class="{{ form.vars.only_hidden ? 'd-none' }}">Hide</th>
        </tr>
        </thead>
        <tbody>
        {% for item in form.references %}
            {% set td_class = item.vars.reference.route is empty ? 'border border-danger bg-warning' %}
            <tr class="align-middle resource-item-container">
                <td class="resource-apply-container align-middle text-center {{ td_class }}">
                    <div class="{{ item.vars.reference.route is empty ? 'd-none' }}">
                        {{ form_widget(item.apply) }}
                    </div>
                </td>
                <td class="{{ td_class }} resource-field-container">
                    {{ form_widget(item.resource) }}
                    {{ form_errors(item.resource) }}
                </td>
                <td class="{{ td_class }}">{{ item.vars.reference.name }}</td>
                <td class="{{ td_class }}">
                    {{ item.vars.reference.route|default("Resource not found in the app") }}
                </td>
                <td class="{{ td_class }}">
                    {{ item.vars.reference.routePath|default("Resource not found in the app") }}
                </td>
                <td class="align-middle text-center {{ form.vars.only_hidden ? 'd-none' }} {{ td_class }}">
                    {{ form_widget(item.hide) }}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <hr>
    <div>
        <input type="submit" value="{{ buttonTitle|default('Save References') }}" class="btn btn-primary">
    </div>

    {{ form_end(form) }}
{% endmacro %}

{% block javascripts %}
    {{ parent() }}
    <script>
        $(function () {
            $(".resource-field-container :input").on('change paste', function () {
                $(this)
                    .closest('.resource-item-container')
                    .find('.resource-apply-container :checkbox')
                    .prop('checked', true);
            });
        });
    </script>
{% endblock %}